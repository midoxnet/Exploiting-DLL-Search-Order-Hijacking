# From user to SYSTEM: Exploiting Windows 10's svchost.exe using DLL Search-Order Hijacking  
  
## Purpose of this repository  
  
1. Inform how Windows searches for DLL files and how this DLL Search-Order can be used to escelate privileges.  
2. Show how to escalate privileges by exploiting the svchost.exe-process to become SYSTEM.    
3. Publish a .dll-file that can be used for further testing other processes for possible DLL Search-Order Hijacking  
  
  
**This project also consists of two files created with Visual Studio 2019.**   
1. EXE-file: A x64-bit .exe-file with one purpose: To load the DLL file
2. DLL-file: A x64-bit .dll-file with one purpose: Write to a text-file the user context of the process loading the DLL.

## How does DLL Search-Order hijacking work?
According to Microsoft's own documentation, there are various factors that play a role in how the system searches for DLL-files:
1. If a DLL file, with the same name, is already loaded in memory, then the system will not search any further. 
2. If the name of the DLL file is present on the list of "Known DLL Files", then the system will refer to this. The list is saved in registry: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs.
3. "If a DLL has dependencies, the system searches for the dependent DLLs as if they were loaded with just their module names. This is true even if the first DLL was loaded by specifying a full path." (https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order). 

If neither of these prerequistes are met, the system will then go through the DLL Search-Order. The order depends on whether safe DLL search mode is enabled or disabled. If safe-search is enabled the DLL Search-Order will be as follows: 
1. The directory from which the application loaded.
2. The system directory. Use the GetSystemDirectory function to get the path of this directory.
3. The 16-bit system directory. There is no function that obtains the path of this directory, but it is searched.
4. The Windows directory. Use the GetWindowsDirectory function to get the path of this directory.
5. The current directory.
6. The directories that are listed in the PATH environment variable. Note that this does not include the per-application path specified by the App Paths registry key. The App Paths key is not used when computing the DLL search path.

If, however, safe search is disabled, then "The current directory" will be searched as the second option. 




Windows systems use a common method to look for required DLLs to load into a program. Adversaries may take advantage of the Windows DLL search order and programs that ambiguously specify DLLs to gain privilege escalation and persistence. (https://attack.mitre.org/techniques/T1038/). 




## POC Exploiting svchost.exe to escalate privileges from user to SYSTEM. 

