# Exploiting DLL Search-Order Hijacking  
  
## Purpose of this repository  
1. How does Windows DLL Search-Order operate? 
2. **(POC)** How to take advantage of the DLL Search-Order to escalate privileges to SYSTEM by hijacking a DLL in the svchost.exe-process? 
3. Publish a .DLL-file to be used for testing of other applications that might be vulnerable to DLL Search-Order hijacking.
   
### 1. How does Windows DLL Search-Order operate?
Application will often load a DLL-file to gain access to specific funtionality. The programmer might have chosen to hard-code the specific path of the DLL-file, but if this is not done, then Windows has a built-in Search-Order that the application will utilize to find the DLL.  According to Microsoft's own documentation, there are various factors that play a role in how the system searches for DLL-files:
1. If a DLL file, with the same name, is already loaded in memory, then the system will use this. 
2. If the name of the DLL file is present on the list of "Known DLL Files". This list is saved in the following registry-key: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs.
3. "If a DLL has dependencies, the system searches for the dependent DLLs as if they were loaded with just their module names. This is true even if the first DLL was loaded by specifying a full path." (https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order). 

If neither of these prerequistes are met, the system will then go through the DLL Search-Order. The order depends on whether "safe DLL search mode" is enabled or disabled. If safe-search is enabled the DLL Search-Order will be as follows: 
1. The directory from which the application loaded.
2. The system directory. Use the GetSystemDirectory function to get the path of this directory.
3. The 16-bit system directory. There is no function that obtains the path of this directory, but it is searched.
4. The Windows directory. Use the GetWindowsDirectory function to get the path of this directory.
5. The current directory.
6. The directories that are listed in the PATH environment variable. Note that this does not include the per-application path specified by the App Paths registry key. The App Paths key is not used when computing the DLL search path.

The current directory will be searched as the second option if safe-search is disabled. 

**So what's the problem?**  
The last step in the Search-Order: The PATH environment variable. When certain software is installed, it creates new references to directories in the PATH variable. Directories that might be writable by unprivileged users. Having write privileges to directories listed in the PATH variable opens up the door for DLL hijacking: 

*"DLL search order hijacking takes advantage of this load process to load malicious DLLs in place of legitimate ones. If an application uses Windowsâ€™ DLL search to find a DLL and the attacker can place an identically-named DLL higher in the order than the legitimate one, the malicious DLL will be loaded by the application. This allows the attacker to run malicious code within a trusted process and may enable privilege escalation if the vulnerable application is running with higher privileges than the attacker has."* https://resources.infosecinstitute.com/mitre-attck-vulnerability-dll-search-order-hijacking/#gref

*For more information on DLL Search-Order and DLL Hijacking:*  
https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order
https://resources.infosecinstitute.com/mitre-attck-vulnerability-dll-search-order-hijacking/#gref
https://attack.mitre.org/techniques/T1038/ 

### For the POC and the code for the DLL file, please see the folder named POC in this repository.
